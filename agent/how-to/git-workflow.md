# Git Workflow Guide

> **TL;DR**: Use `just agent-commit` only when explicitly authorized. Otherwise, always ask the user before committing.

---

## Quick Reference

| Task | Command |
|------|---------|
| Interactive commit | `just commit` |
| Non-interactive commit (agent) | `just agent-commit <type> <scope> "<message>"` |
| Focus on a Spec | `just agent-focus <spec_path>` |
| Check commit messages | `just log` |
| View status | `just status` |

---

## 1. Commit Message Standard

All commits follow the **Conventional Commits** specification:

```
<type>(<scope>): <description>
```

### Type Meanings

| Type | Description |
|------|-------------|
| `feat` | New feature or capability |
| `fix` | Bug fix |
| `docs` | Documentation changes |
| `style` | Formatting, whitespace, etc. (no code change) |
| `refactor` | Code restructure (no behavior change) |
| `perf` | Performance improvement |
| `test` | Adding or fixing tests |
| `build` | Build system or dependencies |
| `ci` | CI/CD pipeline changes |
| `chore` | Maintenance tasks |

### Suggested Scopes

This project uses **standardized scopes** for better traceability:

| Scope | Covers |
|-------|--------|
| `nix` | `devenv.nix`, `units/`, `*.nix` files |
| `mcp` | `mcp-server/` directory |
| `router` | `tool-router/` directory |
| `docs` | `docs/` (user docs), `agent/` (LLM context), `README.md` |
| `cli` | `justfile`, `lefthook.yml` |
| `deps` | `pyproject.toml`, `devenv.lock`, `package.json` |
| `ci` | `.github/`, `.devcontainer/` |

### Scope Sub-categorization (Optional)

For finer granularity, use parentheses after scope:

| Scope | Sub-categories | Examples |
|-------|---------------|----------|
| `docs` | `explanation`, `tutorials`, `readme` | `docs(explanation): add auth concept`, `docs(tutorials): add getting started` |
| `agent` | `specs`, `how-to`, `standards`, `writing-style` | `agent(specs): add feature spec`, `agent(standards): update python style` |
| `cli` | `just`, `lefthook`, `conform` | `cli(just): add new recipe` |

### Good vs Bad Examples

| Bad | Good |
|-----|------|
| `fix: bug` | `fix(mcp): handle connection timeout` |
| `feat: added stuff` | `feat(nix): add redis service` |
| `docs: update` | `docs(readme): add setup instructions` |
| `chore: misc` | `chore(cli): bump just version` |

### Enforcing Standards

This project uses two tools to enforce commit standards:

| Tool | Role | Responsibility |
|------|------|----------------|
| **Conform** | üõ°Ô∏è Police (Enforcer) | Validates commit format at `git commit` time. Rejects invalid messages. |
| **Cog** | üìã Secretary (Helper) | Provides interactive menu for humans, groups changes in CHANGELOG. |

**Conform** checks:
- Format: `<type>(<scope>): <description>`
- Scope must be lowercase
- No illegal characters

**Cog** provides:
- Interactive scope selection menu (for `just commit`)

### Agentic OS Smart Commit

The MCP Server provides a **Smart Commit** tool that generates Conventional Commit messages:

```bash
# Agent workflow
1. Stage changes: git add .
2. Generate message: @omni-orchestrator suggest_commit_message(spec_path="agent/specs/xxx.md")
3. Review & Execute: smart_commit(type="...", scope="...", message="...")
```

**Configuration Source of Truth:**

| File | Generated By | Purpose |
|------|-------------|---------|
| `cog.toml` | `nix run` via `lefthook.nix` (nixago) | Valid scopes for Conventional Commits |
| `.conform.yaml` | `nix run` via `lefthook.nix` (nixago) | Commit message validation rules |
| `agent/how-to/git-workflow.md` | Manual / Spec Kit | Human-readable documentation |

**Key Point:** The MCP tool (`git_ops.py`) dynamically reads `cog.toml` and `.conform.yaml` at runtime, ensuring AI-generated commit messages **always pass CI validation**. These config files are generated by nix, so edits should be made in `units/modules/lefthook.nix` rather than directly.

Both tools share the same scope definitions (nix, mcp, router, docs, cli, deps, ci, version, claude) defined in `lefthook.nix` ‚Üí `project-scopes`.

---

## 2. Workflow for Humans

For manual development, use the interactive commit tool:

```bash
just commit
```

This launches an interactive wizard that guides you through:

1. Selecting commit type (feat, fix, docs, etc.)
2. Optional scope (e.g., "mcp", "cli")
3. Commit message
4. Optional body and breaking changes

---

## 3. Workflow for Agents (LLM)

### Default Rule: "Stop and Ask"

By default, when an Agent (LLM) finishes a task, it **MUST NOT** commit code automatically.

**Agent/LLM Behavior:**

1. Make changes
2. Run tests
3. **STOP**
4. **Ask user for permission** before committing

**Example:**

```
User: "Fix the bug in router."

LLM: Fixed the code -> Ran tests -> "Tests passed. Ready to commit?
You can review: git diff"
```

### Override Rule: `just agent-commit`

The Agent/LLM is authorized to perform an automated commit **ONLY IF** the user's prompt **explicitly contains**:

> `"run just agent-commit"`

**Usage:**
```bash
just agent-commit <type> <scope> "<message>"
```

**Example:**
```bash
# User prompt:
> "Fix the typo in README and run just agent-commit."

# LLM executes:
just agent-commit docs docs "fix typo in readme"
```

### MCP Tool Integration

LLMs should use MCP tools to enforce this protocol:

| Tool | Purpose |
|------|---------|
| `@omni-orchestrator smart_commit` | Validates and executes commits |
| `@omni-orchestrator execute_doc_action` | Reads protocol from this file |

When an LLM triggers a commit, it should:
1. Call `execute_doc_action` with `action="commit"`
2. The tool returns the validated command or "Stop and Ask" status
3. If "Stop and Ask", the LLM must ask the user before proceeding

### Protocol Rules

| Condition | Agent/LLM Action |
|-----------|------------------|
| User says: "Fix the bug" | Fix code ‚Üí Run Tests ‚Üí **ASK USER** to commit |
| User says: "Fix the bug and **run just agent-commit**" | Fix code ‚Üí Run `just agent-commit` |
| User asks LLM to "run git commit" | **ASK USER** first before executing |
| User asks to force push | **REFUSE** - Explain risks, ask user to confirm explicitly |
| Tests fail | **STOP** and report error. Do not commit. |
| Pre-commit hooks fail | **STOP** and report error. Do not commit. |

### Git Safety Rules

- **NEVER** use `git push --force` or `git push --force-with-lease`
- **NEVER** use `git reset --hard` that discards uncommitted changes
- **NEVER** use `git commit --amend` on pushed commits
- For history correction: Use `git revert` or create a new commit
- If force is required: **ASK USER** for explicit confirmation first

---

## 4. The Agent-Commit Protocol

### Safety First

This protocol enforces **"Human-in-the-loop"** by default:

- ‚úÖ Tests always run before commit
- ‚úÖ Pre-commit hooks always execute
- ‚úÖ Default behavior requires user confirmation
- ‚úÖ Only explicit `"run just agent-commit"` enables auto-commit

---

## 5. Smart Error Recovery

When `just agent-commit` fails due to pre-commit hooks, the MCP tool provides intelligent diagnosis and suggested fixes:

| Error Type | Analysis | Suggested Fix |
|------------|----------|---------------|
| `nixfmt` / `fmt` | Formatting checks failed | `just agent-fmt` |
| `vale` | Writing style checks failed | Use `writer.polish_text` to fix |
| `ruff` / `pyflakes` | Python linting failed | Fix python errors shown in logs |
| `secrets` | Secret detection failed | Remove secrets from code immediately |
| `typos` | Spelling check failed | Fix typos shown in output |

**Example Recovery Flow:**
```
1. Agent runs: just agent-commit fix mcp "handle timeout"
2. Pre-commit fails: nixfmt formatting issues
3. MCP returns: {"analysis": "Formatting checks failed", "suggested_fix": "just agent-fmt"}
4. Agent executes: just agent-fmt
5. Retry commit: just agent-commit fix mcp "handle timeout"
6. Success: Commit completed
```

---

## 6. Spec-Driven Development (Phase 5)

Before implementing features, Agents should focus on specifications:

### 6.1 Focus Command

```bash
just agent-focus <spec_path>
```

Example:
```bash
just agent-focus agent/specs/auth_module.md
```

This displays:
- The full Spec content
- Related code structure (mcp-server modules)
- Backlog alignment check
- Instructions to create PLAN in SCRATCHPAD.md

### 6.2 Spec-Aware Commit

The `spec_aware_commit` MCP tool generates commit messages from Spec + Scratchpad:

```bash
1. Agent stages: git add .
2. Agent calls: @omni-orchestrator spec_aware_commit(spec_path="agent/specs/xxx.md")
3. Tool reads: Spec file + SCRATCHPAD.md
4. Tool generates: Conventional commit message with body
5. Agent reviews: Generated message
6. Agent executes: smart_commit(type="...", scope="...", message="...")
```

### 6.3 Spec Template

Use `agent/specs/template.md` for new features. Required sections:

```markdown
# [Feature Name] Technical Specification

## 1. Context & Goal
* User Story: As a [role], I want [feature], so that [benefit].

## 2. Architecture & Design
* Components: Which files will be touched?
* Data Flow: Input -> Process -> Output

## 3. Implementation Plan (Step-by-Step)
1. [ ] Create module_x.py
2. [ ] Add test_module_x.py
3. [ ] Integrate into main.py

## 4. Validation Strategy
* [ ] Unit Test: pytest tests/test_x.py
* [ ] Manual Verify: just run-x
```

### 6.4 Workflow Summary

```
1. just agent-context        ‚Üí See current mission
2. just agent-focus <spec>   ‚Üí Focus on specific feature spec
3. Claude reads spec         ‚Üí Creates PLAN in SCRATCHPAD.md
4. Claude implements         ‚Üí Writes code per spec
5. just agent-commit         ‚Üí Smart commit with auto-fix
```

---

## 7. Troubleshooting

### "just agent-commit" Fails

| Error | Solution |
|-------|----------|
| Invalid type | Use: feat, fix, docs, style, refactor, perf, test, build, ci, chore |
| Tests failed | Fix failing tests first |
| Hooks failed | Run `just agent-fmt` to auto-fix formatting |

### Reverting a Commit

```bash
# Find the commit hash
just log

# Revert (creates a new commit that undoes the change)
git revert <commit-hash>

# Or reset (dangerous, rewrites history)
git reset --soft HEAD~1
```

---

## 8. GitHub CLI (gh) Integration

### When to Prefer gh Over git

| Condition | Use | Rationale |
|-----------|-----|-----------|
| gh installed + auth valid | `gh` | Handles auth, richer context |
| Clone private repo | `gh repo clone` | No manual URL/credential handling |
| PR workflow | `gh pr *` | Structured PR lifecycle |
| Basic git operations | `git` | Direct, no abstraction overhead |

### gh Integration Rules

1. **Check availability first**: If unsure, `gh auth status` to verify
2. **PR workflow**: Always use `gh pr` for create/status/review/checkout
3. **Repo cloning**: Prefer `gh repo clone` for authenticated access
4. **Fallback**: If gh unavailable or unauthenticated, use native git

### Anti-Patterns

- Don't mix gh and git for same workflow (e.g., `gh pr create` + manual `git push`)
- Don't assume gh exists in CI; keep git fallback ready

---

## Related Documentation

- [Commit Conventions](../../agent/writing-style/02_mechanics.md) - Writing clear commit messages
- [Feature Lifecycle](../../agent/standards/feature-lifecycle.md) - Spec-Driven Development, testing requirements
- [CLAUDE.md](../../CLAUDE.md) - Agent instructions

---

*Built on standards. Not reinventing the wheel.*
