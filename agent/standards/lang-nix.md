# Nix Language Standards

> **Philosophy**: Prefer readability over cleverness. Use `nixfmt` for formatting.

## 1. Core Principles

### 1.1 Module System
- **Always use `imports = [...]`** for splitting configurations
- **Pass inputs explicitly** via `specialArgs` or `_module.args`
- **Never rely on global scoping** - make dependencies explicit

### 1.2 Devenv Patterns
```nix
# ✅ Correct: Use imports for module composition
{
  imports = [
    ./modules/python.nix
    ./modules/llm.nix
  ];
}

# ❌ Wrong: No imports, monolithic config
{
  # ... 500 lines of config
}
```

### 1.3 mkNixago Pattern (Critical)
When using `mkNixago`, **dmerge is implicit**:
```nix
# ✅ Correct: Pass only fields to extend, not full override
mkNixago {
  data = {
    cog.executable = "${pkgs.cog}/bin/cog";
    conform.type = "yaml";
  };
}

# ❌ Wrong: Full override (loses dmerge)
mkNixago {
  data = {
    # This OVERWRITES existing config
    conform = { type = "yaml"; };
  };
}
```

## 2. Forbidden Patterns (Anti-Patterns)

| Pattern | Why | Correct Alternative |
|---------|-----|---------------------|
| `with pkgs; ...` | Ambiguous variable origin | Use `pkgs.hello` explicitly |
| `rec { ... }` | Infinite recursion risk | Use `let ... in` or separate lets |
| `builtins.trace "debug" x` | Debug artifacts | Remove before commit |
| `${pkgs.package}/bin/` | Redundant `/bin/` | `${pkgs.package}/bin/name` |

## 3. Project Conventions

### 3.1 Directory Structure
```
units/
├── modules/      # Nix modules (imported by devenv.nix)
│   ├── python.nix
│   ├── llm.nix
│   └── chez.nix
├── overlays/     # Nixpkgs overlays
└── pkgs/         # Custom packages
```

### 3.2 Module Template
```nix
{ config, lib, pkgs, ... }:
let
  cfg = config.modules.my-feature;
in
{
  options.modules.my-feature = {
    enable = lib.mkEnableOption "Enable my-feature";
  };

  config = lib.mkIf cfg.enable {
    # Your config here
  };
}
```

### 3.3 Linting
- Use `statix` for static analysis: `nix statix units/`
- Use `nix fmt` before commit

## 4. Tool-Specific Notes

### 4.1 Lefthook
- Project scopes from lefthook.nix: `nix`, `mcp`, `router`, `docs`, `cli`, `deps`, `ci`, `data`
- Use `lefthook run <hook>` for testing

### 4.2 Cog & Conform
- Configs generated by nixago - **DO NOT edit directly**
- Edit `lefthook.nix` and regenerate

### 4.3 Home Manager
- User configs in `home/` directory
- Use `programs.home-manager.enable = true`

## 5. Related Documentation

| Document | Purpose |
|----------|---------|
| `tool-router/data/examples/nix.edit.jsonl` | Concrete Nix syntax examples |
| `devenv.nix` | Main devenv configuration |
| `lefthook.nix` | Git hooks configuration |
