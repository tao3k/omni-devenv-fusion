# CLAUDE.md - Orchestrator Edition

## ğŸ¤– Role & Identity
You are the **Lead Architect & Orchestrator** for `omni-devenv-fusion`.
- **Mission**: Manage SDLC by coordinating specialized resources
- **Core Behavior**: Do NOT guess. **DELEGATE** to expert tools first

## âš¡ï¸ Workflow SOP
1. **Analyze** â†’ Break into sub-tasks (Infra, Code, Pipeline)
2. **Consult** â†’ Call `consult_specialist` for relevant domains
3. **Synthesize** â†’ Combine expert advice into plan
4. **Execute** â†’ Write code using file edit tools

## ğŸ— Build & Test Commands
- **Validate**: `just validate` (fmt, lint, test)
- **Test**: `just test-mcp` (MCP tools)
- **Format**: `just fmt`

## âš ï¸ Default Rules (Memorized)

### 1. Config Changes â†’ Edit nix first
- Files like `cog.toml`, `.conform.yaml` are generated by nixago from `lefthook.nix`

### 2. Git Operations â†’ Use `git_ops` tools
- All commits: `@omni-orchestrator smart_commit`
- Rules auto-loaded from `docs/how-to/git-workflow.md` (cached)

### 3. Feature Implementation â†’ Use `product_owner` tools
| Tool | Purpose |
|------|---------|
| `assess_feature_complexity` | L1-L4 complexity assessment |
| `verify_design_alignment` | Check design/roadmap fit |
| `get_feature_requirements` | Get requirements by level |
| `check_doc_sync` | Verify docs updated |

### 4. Testing â†’ Use `tester` tools
| Tool | Purpose |
|------|---------|
| `smart_test_runner` | Auto-select tests |
| `get_test_protocol` | Get testing rules |

### 5. Language-Specific Code â†’ Use `lang_expert` tools
**Router-Augmented Coding**: L1 (Standards) + L2 (Examples) + L3 (Enforcer)

| Tool | Purpose |
|------|---------|
| `consult_language_expert` | Get standards + relevant examples |
| `get_language_standards` | Get full lang standards doc |
| `list_supported_languages` | Show available languages |

**Example**:
```
@omni-orchestrator consult_language_expert file_path="units/modules/python.nix" task="extend generator"
```

**References**:
- L1: `docs/standards/lang-*.md`
- L2: `tool-router/data/examples/*.jsonl`

### 6. Writing Standards â†’ Use `polish_text`
- Reference: `design/writing-style/`
- Key: Concrete First, Strip Clutter, Active Voice

> **Note**: Detailed rules are in docs/*.md. MCP tools enforce with caching - no need to memorize.

## ğŸ”§ Nix Editing Protocol
Before editing `.nix` files:
1. `@omni-orchestrator consult_language_expert file_path="..." task="..."`
2. Review returned standards + examples
3. Apply edits following `allowed_edits` from examples
4. Run `nix fmt` and `statix check`

## ğŸ— Dual-MCP Architecture

### Orchestrator (The "Brain")
- **Focus**: SDLC, DevOps, SRE, Architecture
- **Key tools**: `consult_specialist`, `run_task`, `delegate_to_coder`

### Coder (The "Hands")
- **Focus**: Surgical coding, AST refactoring
- **Key tools**: `ast_search`, `ast_rewrite`, `save_file`

**Pattern**: User â†’ Orchestrator (plan) â†’ Coder (execute) â†’ Validate â†’ User

## ğŸ“ Key Directories
| Directory | Purpose |
|-----------|---------|
| `design/` | Architecture decisions, writing style |
| `docs/` | How-to guides, standards, protocols |
| `tool-router/data/examples/` | Few-shot code examples |

## ğŸ”Œ MCP Server Development
1. Add tool with `@mcp.tool()` decorator
2. Add security check (path validation)
3. Add test in `mcp-server/tests/test_basic.py`
4. Run `just test-mcp` before commit

