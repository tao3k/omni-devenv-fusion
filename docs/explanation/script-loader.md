# Script Loader

> Trinity Architecture - Layer 2: Core Skills

## Overview

The Script Loader dynamically discovers and loads skill commands from `scripts/*.py` files using `importlib.util`. It supports hot-reload, relative imports between scripts, and auto-wiring with Foundation decorators.

## Module Architecture

```
assets/skills/{skill_name}/scripts/
├── commands.py      # @skill_command decorated functions
├── engine.py        # Helper functions (imported via relative import)
└── utils.py         # Utility functions (imported via relative import)
```

Each script is loaded as an isolated module registered under:

```
omni.skills.{skill_name}.scripts.{module_name}
```

Example: `omni.skills.terminal.scripts.engine`

## Package Registration

```python
# File: packages/python/core/src/omni/core/skills/script_loader.py

scripts_pkg = f"omni.skills.{self.skill_name}.scripts"
full_module_name = f"{scripts_pkg}.{module_name}"

spec = importlib.util.spec_from_file_location(full_module_name, path)
module = importlib.util.module_from_spec(spec)
module.__package__ = scripts_pkg  # Enables relative imports
spec.loader.exec_module(module)
```

## Relative Imports

Scripts in the same `scripts/` directory can use relative imports:

```python
# assets/skills/terminal/scripts/commands.py
from . import engine  # Imports omni.skills.terminal.scripts.engine

def run_command(cmd: str, args: list[str]) -> str:
    result = engine.run_command(cmd, args)
    return engine.format_result(result, cmd, args)
```

## Defining a Skill Command

```python
# assets/skills/git/scripts/status.py
from omni.foundation.api.decorators import skill_command
from pathlib import Path

@skill_command(
    name="status",
    category="read",
    description="Show git repository status"
)
def git_status(project_root: Path) -> dict:
    """Get current git status."""
    return {"status": "clean"}
```

## Loading Commands

```python
from omni.core.skills.script_loader import ScriptLoader

loader = ScriptLoader(
    scripts_path="assets/skills/git/scripts",
    skill_name="git"
)
loader.load_all()

# Access commands
status_cmd = loader.commands["git.status"]
```

## Decorator Registration

The `@skill_command` decorator (from Foundation V2) stores metadata:

| Attribute           | Purpose                                   |
| ------------------- | ----------------------------------------- |
| `_is_skill_command` | Marker for skill command detection        |
| `_skill_config`     | Generated by Foundation with input_schema |
| `_skill_name`       | Auto-wired by ScriptLoader                |

## Hot Reload Workflow

```
1. Watcher detects file change in skills/
2. Kernel reloads ScriptLoader
3. ScriptLoader re-imports scripts/*.py
4. New commands registered
5. Agent sends notifications/tools/list_changed
6. Client refreshes tools list
```

## Context Injection

```python
# Inject Rust accelerator
loader.inject("rust", rust_git_bridge)

# Access in command function
@skill_command(name="commit")
def git_commit(message: str, rust=None):
    rust.commit(message)
```

## Performance

| Operation          | Time     | Notes                  |
| ------------------ | -------- | ---------------------- |
| Load single script | ~1ms     | importlib.util         |
| Load all commands  | ~10-50ms | Depends on skill count |
| Get command        | O(1)     | Dict lookup            |
| Hot reload         | ~5-20ms  | Incremental            |

## Related Files

**Core:**

- `packages/python/core/src/omni/core/skills/script_loader.py`
- `packages/python/core/src/omni/core/skills/universal.py`

**Foundation:**

- `packages/python/foundation/src/omni/foundation/api/decorators.py`

**Kernel:**

- `packages/python/core/src/omni/core/kernel/components/skill_loader.py`
