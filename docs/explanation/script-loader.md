# Script Loader

> Trinity Architecture - Layer 2: Core Skills

## Overview

The Script Loader dynamically discovers and loads skill commands from `scripts/*.py` files using `importlib.util`. It supports hot-reload and auto-wiring with Foundation decorators.

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│ L2: Core Layer (omni.core.skills)                          │
│                                                              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ ScriptLoader                                           │  │
│  │                                                        │  │
│  │  - scripts_path: Path to skill scripts                 │  │
│  │  - commands: Dict[full_name -> function]               │  │
│  │  - native_functions: Raw functions (no decorator)      │  │
│  │  - _context: Injected dependencies                     │  │
│  │                                                        │  │
│  │  + load_all(): Scan and register all commands         │  │
│  │  + get_command(name): Retrieve command function        │  │
│  │  + inject(key, value): Add dependency to context       │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ @skill_command Decorator                               │  │
│  │                                                        │  │
│  │  - Generates Pydantic V2 input_schema                 │  │
│  │  - Stores _skill_config with command metadata         │  │
│  │  - Auto-wires skill name from ScriptLoader            │  │
│  └───────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│ L1: Foundation Layer (omni.foundation)                      │
│  - @skill_command decorator                                 │
│  - get_script_config()                                      │
│  - OrjsonModel (for CommandResult)                          │
└─────────────────────────────────────────────────────────────┘
```

## Directory Structure

```
assets/skills/{skill_name}/
├── SKILL.md              # Skill manifest + system prompts
├── scripts/
│   ├── __init__.py       # Module loader (importlib.util)
│   └── commands.py       # @skill_command decorated functions
├── tests/
│   └── test_*.py
└── extensions/
    └── sniffer/
        └── rules.toml    # Declarative sniffer rules
```

## Usage

### Defining a Skill Command

```python
# assets/skills/git/scripts/commands.py
from omni.core.skills.script_loader import skill_command

@skill_command(
    name="status",
    category="read",
    description="Show git repository status"
)
def git_status(project_root: Path) -> CommandResult[dict]:
    """Get current git status."""
    result = run_git_status(project_root)
    return CommandResult(success=True, data=result)
```

### Loading Commands

```python
from omni.core.skills.script_loader import ScriptLoader

loader = ScriptLoader(
    scripts_path="assets/skills/git/scripts",
    skill_name="git"
)
loader.load_all()

# Access commands
status_cmd = loader.commands["git.status"]
config = get_script_config(status_cmd)
# {
#     "name": "git_status",
#     "category": "read",
#     "input_schema": {...},
#     "execution": {...}
# }
```

### Hot Reload

```python
# Reload scripts on file change
loader.load_all()  # Re-scans scripts directory
```

## Decorator Registration

The `@skill_command` decorator stores metadata on the function:

| Attribute           | Purpose                                  |
| ------------------- | ---------------------------------------- |
| `_is_skill_command` | Marker for skill command detection       |
| `_command_name`     | Command name (defaults to function name) |
| `_skill_name`       | Auto-wired by ScriptLoader               |
| `_category`         | Command category (read/write/execute)    |
| `_description`      | Human-readable description               |
| `_inject_root`      | Whether to inject project root path      |
| `_skill_config`     | Generated by Foundation (V2)             |

## Context Injection

```python
# Inject Rust accelerator
loader.inject("git_accelerator", rust_git_bridge)

# Access in command function
@skill_command(name="commit")
def git_commit(..., git_accelerator=None):
    git_accelerator.commit(message)
```

## Hot Reload Workflow

```
1. Watcher detects file change in skills/
2. Kernel reloads ScriptLoader
3. ScriptLoader re-imports scripts/*.py
4. New commands registered
5. Agent sends notifications/tools/list_changed
6. Client refreshes tools list
```

## Performance

| Operation          | Time     | Notes                  |
| ------------------ | -------- | ---------------------- |
| Load single script | ~1ms     | importlib.util         |
| Load all commands  | ~10-50ms | Depends on skill count |
| Get command        | O(1)     | Dict lookup            |
| Hot reload         | ~5-20ms  | Incremental            |

## Related Files

**Core:**

- `packages/python/core/src/omni/core/skills/script_loader.py`
- `packages/python/core/src/omni/core/skills/universal.py`

**Foundation:**

- `packages/python/foundation/src/omni/foundation/api/decorators.py`

**Tests:**

- `packages/python/core/tests/units/test_script_loader.py`
