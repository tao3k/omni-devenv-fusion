name: Setup Environment
inputs:
  CACHIX_AUTH_TOKEN:
    required: true
    description: "Cachix Auth Token"
  SECRET_GITHUB_TOKEN:
    required: true
    description: "Github Secret Token"
  MINIMAX_API_KEY:
    required: true
    description: "MiniMax API Key"
runs:
  using: "composite"
  permissions:
    contents: read
    id-token: write
  steps:
    - uses: DeterminateSystems/nix-installer-action@main
      with:
        extra-conf: |
          accept-flake-config = true
        github_token: ${{ inputs.SECRET_GITHUB_TOKEN }}

    - uses: DeterminateSystems/magic-nix-cache-action@main

    - uses: cachix/cachix-action@v16
      with:
        name: devenv

    - name: Install devenv.sh
      shell: bash
      run: nix profile add nixpkgs#devenv

    - name: Install secretspec and write .env
      shell: bash
      env:
        MINIMAX_API_KEY: ${{ inputs.MINIMAX_API_KEY }}
      run: |
        nix profile add nixpkgs#secretspec
        echo "MINIMAX_API_KEY=$MINIMAX_API_KEY" > .env
        # NAR hash mismatch in input issue, I don't know why
        # nix flake update omnibus
